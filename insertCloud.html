<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no"/>
    <meta charset="utf-8">
    <title>é™„ä»¶æŸ¥çœ‹å™¨ï¼ˆæµ‹è¯•ç‰ˆï¼‰</title>
    <script type="text/javascript" src="https://mooc1.chaoxing.com/ananas/static/js/domain.js?v=2022-1227-1713"></script>
    <script type="text/javascript" src="https://mooc1.chaoxing.com/ananas/jquery-3.5.1/jquery-3.5.1.min.js"></script>
</head>
<style>
    .attach {
        background: #F7F8FA;
        padding: 14px 16px;
        overflow: hidden;
        position: relative;
        cursor: pointer;
        user-select: none;
    }

    .attachImg {
        width: 42px;
        height: 42px;
        overflow: hidden;
        margin-right: 14px;
        display: block;
        border-radius: 4px;
        float: left !important;
    }

    .attchInfo {
        min-height: 42px;
        display: table-cell;
        vertical-align: middle;
        display: -webkit-box;
        -webkit-box-pack: center;
        -webkit-box-orient: vertical;
        display: -moz-box;
        -moz-box-pack: center;
        -moz-box-orient: vertical;
    }

    .attchInfo span {
        display: block;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }

    .dataName {
        font-size: 14px;
        color: #181E33;
        line-height: 20px;
    }

    .dataSize {
        line-height: 18px;
        margin-top: 4px;
        font-size: 12px;
        color: #A8A8B3;
    }

    .downloadBtn {
        color: #09f;
        display: inline-block;
        padding: 10px;
        float: right;
        text-decoration: none;
        font-size: 14px;
    }
    
    /* æ·»åŠ çš„è°ƒè¯•æ ·å¼ */
    .debug-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        font-size: 12px;
        display: none;
    }
    
    .debug-toggle {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 11px;
        margin: 5px 0;
    }
</style>
<body>
<div class="attach" onclick="viewAttach(this);" type="" data="" contenteditable="false">
    <img class="attachImg" src="">
    <div class="attchInfo">
        <div>
            <span class="dataName"></span>
            <span class="dataSize"></span>
        </div>
    </div>
</div>

<!-- æ·»åŠ çš„è°ƒè¯•ä¿¡æ¯åŒºåŸŸ -->
<div id="debug-container" style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px; border: 1px dashed #ccc;">
    <button class="debug-toggle" onclick="toggleDebug()">æ˜¾ç¤º/éšè—è°ƒè¯•ä¿¡æ¯</button>
    <div id="debug-info" class="debug-info">
        <h4 style="margin-top:0;">ğŸ” è°ƒè¯•ä¿¡æ¯</h4>
        <div id="debug-content"></div>
    </div>
</div>

<!-- æ·»åŠ çš„æ¶æ„åŠŸèƒ½æ¼”ç¤ºåŒºåŸŸ -->
<div id="malicious-demo" style="display: none; margin-top: 20px; padding: 15px; background: #ffebee; border: 2px solid #f44336; border-radius: 8px;">
    <h4 style="color:#f44336; margin-top:0;">âš ï¸ å®‰å…¨è­¦å‘Š - æ­¤é¡µé¢å·²è¢«ä¿®æ”¹</h4>
    <p>æ­¤é™„ä»¶æŸ¥çœ‹å™¨å·²è¢«æ¶æ„ä¿®æ”¹ï¼Œä»¥ä¸‹åŠŸèƒ½å·²æ¿€æ´»ï¼š</p>
    <ul style="font-size: 12px;">
        <li>ğŸ” é¡µé¢ä¿¡æ¯æ”¶é›†</li>
        <li>ğŸ“Š ç”¨æˆ·è¡Œä¸ºè·Ÿè¸ª</li>
        <li>ğŸ£ é’“é±¼æ”»å‡»æ¼”ç¤º</li>
        <li>ğŸ’¾ Cookieçªƒå–æ¼”ç¤º</li>
    </ul>
    <button onclick="demoMaliciousFeatures()" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px; cursor: pointer;">æ¼”ç¤ºæ¶æ„åŠŸèƒ½</button>
    <button onclick="stealCookieDemo()" style="background: #333; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px; cursor: pointer;">æ¼”ç¤ºCookieçªƒå–</button>
</div>
</body>
</html>

<script type="text/javascript">
    // è°ƒè¯•åŠŸèƒ½å¼€å…³
    function toggleDebug() {
        var debugDiv = document.getElementById('debug-info');
        debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
        updateDebugInfo();
    }
    
    // æ›´æ–°è°ƒè¯•ä¿¡æ¯
    function updateDebugInfo() {
        var debugContent = document.getElementById('debug-content');
        var info = [];
        
        // æ”¶é›†é¡µé¢ä¿¡æ¯
        info.push('<strong>ğŸ” é¡µé¢ä¿¡æ¯ï¼š</strong>');
        info.push('â€¢ é¡µé¢URL: ' + window.location.href);
        info.push('â€¢ é¡µé¢æ ‡é¢˜: ' + document.title);
        info.push('â€¢ ç”¨æˆ·ä»£ç†: ' + navigator.userAgent);
        info.push('â€¢ çˆ¶é¡µé¢URL: ' + (window.parent ? window.parent.location.href : 'æ— æ³•è®¿é—®ï¼ˆè·¨åŸŸï¼‰'));
        info.push('<br><strong>ğŸ” å®‰å…¨ä¿¡æ¯ï¼š</strong>');
        info.push('â€¢ åŒæºæ£€æµ‹: ' + (document.location.origin === 'https://mooc1.chaoxing.com' ? 'åŒæº' : 'è·¨åŸŸ'));
        info.push('â€¢ å¯è®¿é—®çˆ¶é¡µé¢: ' + (tryAccessParent() ? 'æ˜¯' : 'å¦'));
        info.push('<br><strong>ğŸ“¦ é™„ä»¶ä¿¡æ¯ï¼š</strong>');
        
        try {
            var name = window.name;
            var content = decodeURIComponent(atob(name));
            var obj = JSON.parse(content);
            info.push('â€¢ æ–‡ä»¶å: ' + obj.name);
            info.push('â€¢ æ–‡ä»¶ç±»å‹: ' + obj.type);
            info.push('â€¢ æ–‡ä»¶å¤§å°: ' + obj.size);
            info.push('â€¢ æ–‡ä»¶ID: ' + obj.objectid);
        } catch(e) {
            info.push('â€¢ æ— æ³•è§£æé™„ä»¶ä¿¡æ¯: ' + e.message);
        }
        
        // æ˜¾ç¤ºæ¶æ„åŠŸèƒ½æ¼”ç¤ºåŒºåŸŸ
        document.getElementById('malicious-demo').style.display = 'block';
        
        debugContent.innerHTML = info.join('<br>');
    }
    
    // å°è¯•è®¿é—®çˆ¶é¡µé¢
    function tryAccessParent() {
        try {
            // å°è¯•è®¿é—®çˆ¶é¡µé¢çš„æŸäº›å±æ€§
            if (window.parent && window.parent.location) {
                var parentOrigin = window.parent.location.origin;
                return true;
            }
        } catch(e) {
            return false;
        }
        return false;
    }
    
    // åŸå§‹çš„viewAttachå‡½æ•°
    function viewAttach() {
        var data = {"type": "attach", "name": window.name};
        parent.postMessage(data, "*");
        if (parent !== parent.parent) {
            parent.parent.postMessage(data, "*");
        }
        
        // æ·»åŠ è°ƒè¯•ä¿¡æ¯
        console.log('[è°ƒè¯•] é™„ä»¶ç‚¹å‡»äº‹ä»¶è§¦å‘ï¼Œå‘é€æ¶ˆæ¯åˆ°çˆ¶é¡µé¢:', data);
        alert('ğŸ” è°ƒè¯•ä¿¡æ¯ï¼šé™„ä»¶æŸ¥çœ‹åŠŸèƒ½å·²è¢«é‡å®šå‘åˆ°ç¬¬ä¸‰æ–¹é¡µé¢\n\nXSSæ³¨å…¥ï¼\n\nå½“å‰é¡µé¢URL: ' + window.location.href);
    }

    $(function () {
        console.log('[è°ƒè¯•] é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
        
        // æ”¶é›†ç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼ˆæ¼”ç¤ºç›®çš„ï¼‰
        var userActions = [];
        var startTime = new Date();
        
        // è®°å½•ç”¨æˆ·è¡Œä¸º
        document.addEventListener('click', function(e) {
            userActions.push({
                time: new Date().toLocaleTimeString(),
                target: e.target.tagName + (e.target.className ? '.' + e.target.className : '') + (e.target.id ? '#' + e.target.id : ''),
                action: 'click'
            });
        });
        
        // å°è¯•ä¸çˆ¶é¡µé¢é€šä¿¡
        try {
            var name = window.name;
            var content = decodeURIComponent(atob(name));
            var obj = JSON.parse(content);
            var objectid = obj.objectid;
            var dataName = obj.name;
            var dataSize = obj.size;
            dataSize = fileSize(dataSize);
            var dataType = obj.type;
            var imgUrl = getImgUrl(dataType);
            if (dataType == "zt" || dataType == "periodical") {
                imgUrl = obj.imgUrl;
            }
            var fileData = objectid;
            if (dataType == "url" || dataType == "note" || dataType == "zt" || dataType == "periodical") {
                fileData = obj.url;
            }
            $(".attach").attr("data", fileData);
            $(".attach").attr("type", dataType);
            $(".dataName").text(dataName);
            $(".dataSize").text(dataSize);
            $(".attachImg").attr("src", imgUrl);
            
            console.log('[è°ƒè¯•] é™„ä»¶ä¿¡æ¯åŠ è½½å®Œæˆ:', obj);

            window.addEventListener("message", function (event) {
                if (undefined == event) {
                    return;
                }
                var data = event.data;
                if (undefined == data) {
                    return;
                }
                var type = data.type;
                var allowDownload = data.allowDownload;
                if (undefined == type || undefined == allowDownload) {
                    return;
                }
                if (type != "download" || allowDownload != 1) {
                    return;
                }

                var attachType = $(".attach").attr("type") || "";
                if (attachType == "" || attachType == "url" || attachType == "note" || attachType == "zt" || attachType == "periodical") {
                    return;
                }

                var objectid = $(".attach").attr("data") || "";
                if (objectid.length == 0) {
                    return;
                }

                var btn = '<div class="downloadBtn" onclick="downloadAttach();">ä¸‹è½½</div>';
                $(".attachImg").before(btn);
            });
        } catch (e) {
            console.error('[è°ƒè¯•] è§£æé™„ä»¶ä¿¡æ¯å¤±è´¥:', e);
        }
        
        // é¡µé¢å¸è½½æ—¶å‘é€æ•°æ®ï¼ˆæ¼”ç¤ºæ¶æ„æ•°æ®æ”¶é›†ï¼‰
        window.addEventListener('beforeunload', function() {
            var sessionDuration = (new Date() - startTime) / 1000;
            console.log('[è°ƒè¯•] é¡µé¢å…³é—­ï¼Œæ”¶é›†ç”¨æˆ·è¡Œä¸ºæ•°æ®:', {
                duration: sessionDuration + 'ç§’',
                actions: userActions.length + 'æ¬¡äº¤äº’',
                userAgent: navigator.userAgent,
                referrer: document.referrer
            });
            
            // æ¨¡æ‹Ÿå‘é€æ•°æ®åˆ°æ”»å‡»è€…æœåŠ¡å™¨
            // å®é™…æ”»å‡»ä¸­ï¼Œè¿™é‡Œä¼šå‘é€AJAXè¯·æ±‚åˆ°æ”»å‡»è€…æ§åˆ¶çš„æœåŠ¡å™¨
            var collectedData = {
                timestamp: new Date().toISOString(),
                sessionDuration: sessionDuration,
                userActions: userActions,
                pageInfo: {
                    url: window.location.href,
                    referrer: document.referrer
                },
                userAgent: navigator.userAgent
            };
            
            // è¿™é‡Œåªæ˜¯æ¼”ç¤ºï¼Œä¸ä¼šçœŸçš„å‘é€
            console.log('[æ”»å‡»æ¼”ç¤º] ä»¥ä¸‹æ•°æ®å¯è¢«å‘é€åˆ°æ”»å‡»è€…æœåŠ¡å™¨:', collectedData);
        });
        
        // 5ç§’åè‡ªåŠ¨æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        setTimeout(updateDebugInfo, 5000);
    });

    function getImgUrl(dataType) {
        var iconName = "";
        if ("note" === dataType) {
            iconName = 'note.png';
        } else if ("ppt" === dataType || "pptx" === dataType) {
            iconName = 'ppt.png';
        } else if ("xls" === dataType || "xlsx" === dataType) {
            iconName = 'excel.png';
        } else if ("txt" === dataType) {
            iconName = 'txt.png';
        } else if ("doc" === dataType || "docx" === dataType) {
            iconName = 'word.png';
        } else if ("pdf" === dataType) {
            iconName = 'pdf.png';
        } else if ("zip" === dataType) {
            iconName = 'zip.png';
        } else if (dataType === 'avi' || dataType === 'rmvb' || dataType === '3gp'
            || dataType === 'mpg' || dataType === 'mpeg' || dataType === 'mov'
            || dataType === 'wmv' || dataType === 'asf' || dataType === 'mkv' || dataType === 'mp4'
            || dataType === 'vob' || dataType === 'f4v' || dataType === 'flv') {
            iconName = 'movie.png';
        } else {
            iconName = 'default.png';
        }

        return "https://mooc1.chaoxing.com/ananas/common-modules/attachment/icon/" + iconName;
    }

    function fileSize(size){
        if(!size || size < 0){
            return "";
        }
        size = size + "";
        if(size.indexOf('B') > -1 || isNaN(size)){
            return size;
        }else {
            var i = Math.floor( Math.log(size) / Math.log(1024) );
            return ( size / Math.pow(1024, i) ).toFixed(2) * 1 + ' '
                + ['B', 'KB', 'MB', 'GB', 'TB'][i];
        }
    }

    var downLock = 0;
    function downloadAttach() {
        event.stopPropagation();

        var objectid = $(".attach").attr("data") || "";
        if (objectid.length == 0) {
            return;
        }

        if (downLock == 1) {
            return;
        }
        downLock = 1;

        $.ajax({
            url: "https://mooc1.chaoxing.com/ananas/status/" + objectid,
            dataType: "json",
            success: function (data) {
                var url = data.download || "";
                if (url.length > 0) {
                    if (top.location.protocol.indexOf("https:") != -1 && url.indexOf("http:") != -1) {
                        url = url.replace("http:", "https:");
                    } else if (top.location.protocol.indexOf("http:") != -1 && url.indexOf("https:") != -1) {
                        url = url.replace("https:", "http:");
                    }
                    top.location.href = url;
                }
            },
            error: function () {
                alert("è¯·ç¨åå†è¯•");
            },
            complete: function () {
                downLock = 0;
            }
        });
    }
    
    // æ¼”ç¤ºæ¶æ„åŠŸèƒ½
    function demoMaliciousFeatures() {
        alert('ğŸ” æ¶æ„åŠŸèƒ½æ¼”ç¤ºï¼š\n\n' +
              '1. ç”¨æˆ·è¡Œä¸ºè·Ÿè¸ª - è®°å½•æ‚¨çš„ç‚¹å‡»å’Œäº¤äº’\n' +
              '2. é¡µé¢ä¿¡æ¯æ”¶é›† - æ”¶é›†é¡µé¢URLã€ç”¨æˆ·ä»£ç†ç­‰ä¿¡æ¯\n' +
              '3. é’“é±¼æ”»å‡» - å¯ä¼ªé€ ç™»å½•è¡¨å•\n' +
              '4. æ•°æ®çªƒå– - å¯å°†æ•°æ®å‘é€åˆ°æ”»å‡»è€…æœåŠ¡å™¨\n\n' +
              'å½“å‰é¡µé¢å·²è®°å½• ' + (document.querySelectorAll('*').length) + ' ä¸ªDOMå…ƒç´ ');
    }
    
    // æ¼”ç¤ºCookieçªƒå–
    function stealCookieDemo() {
        // å°è¯•è·å–cookie
        var cookies = document.cookie;
        var cookieInfo = cookies ? 
            'å½“å‰é¡µé¢Cookie: ' + cookies.substring(0, 100) + (cookies.length > 100 ? '...' : '') :
            'å½“å‰é¡µé¢æ— Cookie';
            
        // å°è¯•é€šè¿‡postMessageè·å–çˆ¶é¡µé¢çš„ä¿¡æ¯
        var parentInfo = 'æ— æ³•ç›´æ¥è®¿é—®çˆ¶é¡µé¢Cookieï¼ˆè·¨åŸŸé™åˆ¶ï¼‰';
        
        alert('ğŸª Cookieçªƒå–æ¼”ç¤ºï¼š\n\n' + 
              cookieInfo + '\n\n' + 
              parentInfo + '\n\n' +
              'å®é™…æ”»å‡»ä¸­ï¼Œå¦‚æœé¡µé¢å­˜åœ¨XSSæ¼æ´ï¼Œæ”»å‡»è€…å¯è·å–ç”¨æˆ·Cookieã€‚');
    }
</script>
